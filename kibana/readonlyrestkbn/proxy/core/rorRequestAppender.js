"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.RorRequestAppender=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _rorRequestCreator=require("./rorRequest/rorRequestCreator");var __awaiter=void 0&&(void 0).__awaiter||function(e,i,t,u){function o(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function n(e){try{s(u.next(e))}catch(e){t(e)}}function a(e){try{s(u["throw"](e))}catch(e){t(e)}}function s(e){e.done?r(e.value):o(e.value).then(n,a)}s((u=u.apply(e,i||[])).next())})};var RorRequestAppender=function(){function n(e,r){var t=this;(0,_classCallCheck2.default)(this,n);this.appendIdentitySession=function(n,e,a){return __awaiter(t,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.hasValidSession(n.rorRequest);case 2:if(r.sent){r.next=5;break}a();return r.abrupt("return");case 5:r.next=7;return this.getIdentitySession(n.rorRequest);case 7:t=r.sent;n.rorRequest.setIdentitySession(t);a();return r.abrupt("return");case 11:case"end":return r.stop()}}},e,this)}))};this.sessionManager=e;this.cookieManager=r}(0,_createClass2.default)(n,[{key:"hasValidSession",value:function e(n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.cookieManager.decryptRorCookieFromHeader(n.getCookies());case 2:t=r.sent;r.t1=t;if(!r.t1){r.next=8;break}r.next=7;return this.sessionManager.exists(t);case 7:r.t1=r.sent;case 8:r.t0=r.t1;if(!r.t0){r.next=13;break}r.next=12;return this.sessionManager.isSessionExpired(t);case 12:r.t0=!r.sent;case 13:return r.abrupt("return",r.t0);case 14:case"end":return r.stop()}}},e,this)}))}},{key:"getIdentitySession",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,n;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.cookieManager.decryptRorCookieFromHeader(a.getCookies());case 2:t=r.sent;if(!(t==null)){r.next=5;break}return r.abrupt("return",null);case 5:r.next=7;return this.sessionManager.get(t);case 7:n=r.sent;if(!(n==null)){r.next=10;break}return r.abrupt("return",null);case 10:return r.abrupt("return",{sid:t,metadata:n});case 11:case"end":return r.stop()}}},e,this)}))}}],[{key:"appendRorRequest",value:function e(r,t,n){r.rorRequest=_rorRequestCreator.RorRequestCreator.fromExpressRequest(r);n()}}]);return n}();exports.RorRequestAppender=RorRequestAppender;