"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.EsHostBalancer=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _nodeFetch=_interopRequireDefault(require("node-fetch"));var _httpErrors=_interopRequireDefault(require("http-errors"));var _distributionInfoProvider=require("../../kibana/patchers/distributionInfoProvider");var _esSecurityHeaderBuilder=require("./common/esSecurityHeaderBuilder");var _rorLoggerFactory=require("./logging/rorLoggerFactory");var _nodeAbortController=require("node-abort-controller");var __awaiter=void 0&&(void 0).__awaiter||function(e,a,t,s){function u(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function i(e){try{o(s["throw"](e))}catch(e){t(e)}}function o(e){e.done?r(e.value):u(e.value).then(n,i)}o((s=s.apply(e,a||[])).next())})};var EsHostBalancer=function(){function i(e,r,t,n){(0,_classCallCheck2.default)(this,i);this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.esHosts=e;this.networkParameters=r;this.kibanaTechUserEsCredentials=t;this.esSSLConnectionProvider=n;this.mostRecentlyActiveHostIndex=0;if(e.length>1||_distributionInfoProvider.DistributionInfoProvider.isEnvironmentDev()){this.activateProbe()}}(0,_createClass2.default)(i,[{key:"getElasticsearchUrl",value:function e(){return this.esHosts[this.mostRecentlyActiveHostIndex]}},{key:"activateProbe",value:function e(){var r=this;setInterval(function(){return r.probe().catch(function(e){return r.logger.error(e)})},this.networkParameters.pingTimeout)}},{key:"probe",value:function e(){var r=this;var t=this.getElasticsearchUrl();var n=_esSecurityHeaderBuilder.EsSecurityHeaderBuilder.headerForGetRequestFrom(this.kibanaTechUserEsCredentials);return this.fetchWithTimeout(t,{headers:n,agent:this.esSSLConnectionProvider.getConnectionAgent()}).catch(function(e){if(e.code==="ECONNREFUSED"||e.code==="ECONNRESET"||e.name==="AbortError"){r.circularIncrementHostsArray();throw(0,_httpErrors.default)(503,"Elasticsearch host ".concat(t," is unavailable"))}r.logger.error(e)})}},{key:"fetchWithTimeout",value:function e(s){var u=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t=this;var n,i,o,a;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:n=this.networkParameters.pingTimeout;i=new _nodeAbortController.AbortController;o=setTimeout(function(){t.logger.warn("Probe request timeout after ".concat(n," milliseconds"));i.abort()},n);r.next=5;return(0,_nodeFetch.default)(s,Object.assign(Object.assign({},u),{signal:i.signal}));case 5:a=r.sent;clearTimeout(o);return r.abrupt("return",a);case 8:case"end":return r.stop()}}},e,this)}))}},{key:"circularIncrementHostsArray",value:function e(){this.mostRecentlyActiveHostIndex=++this.mostRecentlyActiveHostIndex%this.esHosts.length}}]);return i}();exports.EsHostBalancer=EsHostBalancer;