"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.EsIndexClient=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _cryptoJs=_interopRequireDefault(require("crypto-js"));var _rorLoggerFactory=require("../logging/rorLoggerFactory");function _createForOfIteratorHelper(t,e){var r;if(typeof Symbol==="undefined"||t[Symbol.iterator]==null){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&typeof t.length==="number"){if(r)t=r;var n=0;var a=function e(){};return{s:a,n:function e(){if(n>=t.length)return{done:true};return{done:false,value:t[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i=true,s=false,o;return{s:function e(){r=t[Symbol.iterator]()},n:function e(){var t=r.next();i=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!i&&r.return!=null)r.return()}finally{if(s)throw o}}}}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}var __awaiter=void 0&&(void 0).__awaiter||function(e,s,r,o){function u(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function n(e){try{i(o.next(e))}catch(e){r(e)}}function a(e){try{i(o["throw"](e))}catch(e){r(e)}}function i(e){e.done?t(e.value):u(e.value).then(n,a)}i((o=o.apply(e,s||[])).next())})};var cacheSize=1e3;var searchParams={size:cacheSize,sort:[{expiresAt:{order:"desc",unmapped_type:"long"}}]};var EsIndexClient=function e(t,r,n){var a=this;(0,_classCallCheck2.default)(this,e);this.indexName=t;this.sessionKey=r;this.esClient=n;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.createSessionIndex=function(){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.prev=0;r={settings:{number_of_shards:1,auto_expand_replicas:"0-1"}};t.next=4;return this.esClient.putAsKibana(this.indexName,r);case 4:t.next=9;break;case 6:t.prev=6;t.t0=t["catch"](0);if(t.t0&&JSON.stringify(t.t0).includes('resource_already_exists_exception')){this.logger.debug("The index "+this.indexName+" already exists.")}else{this.logger.error("Unexpected error creating the in-index session manager",t.t0)}case 9:case"end":return t.stop()}}},e,this,[[0,6]])}))};this.getSessions=function(){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.esClient.postAsKibana(this.indexSearchPath,JSON.stringify(searchParams));case 2:r=t.sent;t.next=5;return r.json();case 5:n=t.sent;if(r.status>=300){this.logger.warn("Failed fetching sessions: "+n)}a=this.extractSessionsFromResponse(n);this.logger.trace("Fetched all sessions from index, found: "+a.size);return t.abrupt("return",this.cleanFromInvalidSessions(a));case 10:case"end":return t.stop()}}},e,this)}))};this.saveInIndex=function(r,n){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.esClient.postAsKibana("".concat(this.indexDocumentPath,"/").concat(r,"?refresh=true"),JSON.stringify(this.encryptIdentitySessionMetadata(n)));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}},e,this)}))};this.getFromIndex=function(i){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.esClient.getAsKibana("".concat(this.indexDocumentPath,"/").concat(i));case 2:r=t.sent;t.next=5;return r.json();case 5:n=t.sent;a=this.parseSessionFromResponse(n);return t.abrupt("return",a&&a[1]||null);case 8:case"end":return t.stop()}}},e,this)}))};this.deleteFromIndex=function(r){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:this.logger.debug("Deleting session with SID:"+r+" from index");t.next=3;return this.esClient.deleteAsKibana("".concat(this.indexDocumentPath,"/").concat(r));case 3:case"end":return t.stop()}}},e,this)}))};this.deleteFromIndexBatch=function(r){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.esClient.deleteBatchAsKibana("".concat(this.indexDocumentPath,"/_delete_by_query"),r);case 2:case"end":return t.stop()}}},e,this)}))};this.extractSessionsFromResponse=function(e){var t=e.hits.hits.map(a.parseSessionFromResponse).filter(function(e){return e!=null});return new Map(t)};this.parseSessionFromResponse=function(e){var t=e["_id"];var r=e["_source"];try{if(t==null||t=="null"){return null}var n=a.decryptIdentitySessionMetadata(r);if(!n){a.logger.debug("Could not decrypt session metadata. Session invalid for SID: "+t);return[t,null]}if(!n.authorizationHeaders){a.logger.debug("Could not find authorizationHeaders. Session invalid for SID: "+t);return[t,null]}return[t,n]}catch(e){if(e instanceof Error){e=e.message}a.logger.debug("Error while parsing sessions from response for SID:",e);return[t,null]}};this.decryptIdentitySessionMetadata=function(e){var t=_cryptoJs.default.AES.decrypt(e.encryptedAuthorizationHeaders,a.sessionKey).toString(_cryptoJs.default.enc.Utf8);return{expiresAt:new Date(e.expiresAt),lastSessionActivityDate:e.lastSessionActivityDate?new Date(e.lastSessionActivityDate):undefined,authorizationHeaders:new Map(JSON.parse(t)),username:e.username,currentGroup:e.currentGroup,availableGroups:e.availableGroups?e.availableGroups:[],kibanaHiddenApps:e.kibanaHiddenApps,kibanaAccess:e.kibanaAccess,kibanaIndex:e.kibanaIndex,kibanaTemplateIndex:e.kibanaTemplateIndex,origin:e.origin}};this.encryptIdentitySessionMetadata=function(e){var t=_cryptoJs.default.AES.encrypt(JSON.stringify(Array.from(e.authorizationHeaders.entries())),a.sessionKey).toString();return{expiresAt:e.expiresAt.getTime(),lastSessionActivityDate:e.lastSessionActivityDate?e.lastSessionActivityDate.getTime():undefined,encryptedAuthorizationHeaders:t,username:e.username,currentGroup:e.currentGroup,availableGroups:e.availableGroups,kibanaHiddenApps:e.kibanaHiddenApps,kibanaAccess:e.kibanaAccess,kibanaIndex:e.kibanaIndex,kibanaTemplateIndex:e.kibanaTemplateIndex,origin:e.origin}};this.cleanFromInvalidSessions=function(u){return __awaiter(a,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a,i,s,o;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=new Map;n=[];a=_createForOfIteratorHelper(u.keys());try{for(a.s();!(i=a.n()).done;){s=i.value;o=u.get(s);if(o==null){this.logger.warn("Could not find a valid session in index for SID ".concat(s," (probably the cookiePass or internal format changed?)"));n.push(s)}else{r.set(s,o)}}}catch(e){a.e(e)}finally{a.f()}t.next=6;return this.deleteFromIndexBatch(n);case 6:return t.abrupt("return",r);case 7:case"end":return t.stop()}}},e,this)}))};this.indexSearchPath=t+e.SEARCH_PATH;this.indexDocumentPath=t+e.DOCUMENT_PATH};exports.EsIndexClient=EsIndexClient;EsIndexClient.SEARCH_PATH="/_search";EsIndexClient.DOCUMENT_PATH="/_doc";