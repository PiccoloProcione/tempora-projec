"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.IndexBasedSessionManager=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _sessionManager=require("./sessionManager");var _lazyUtils=require("../lazyUtils");var _rorLoggerFactory=require("../logging/rorLoggerFactory");function _createSuper(i){var s=_isNativeReflectConstruct();return function e(){var t=(0,_getPrototypeOf2.default)(i),r;if(s){var n=(0,_getPrototypeOf2.default)(this).constructor;r=Reflect.construct(t,arguments,n)}else{r=t.apply(this,arguments)}return(0,_possibleConstructorReturn2.default)(this,r)}}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true}catch(e){return false}}var __awaiter=void 0&&(void 0).__awaiter||function(e,a,r,o){function u(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function n(e){try{s(o.next(e))}catch(e){r(e)}}function i(e){try{s(o["throw"](e))}catch(e){r(e)}}function s(e){e.done?t(e.value):u(e.value).then(n,i)}s((o=o.apply(e,a||[])).next())})};var IndexBasedSessionManager=function(e){(0,_inherits2.default)(a,e);var s=_createSuper(a);function a(e,t,r,n){var i;(0,_classCallCheck2.default)(this,a);i=s.call(this);i.sessionTimeoutMillis=e;i.sessionManager=t;i.indexClient=r;i.refreshAfter=n;i.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);i.sessionsFromIndex=new Map;i.set=function(r,n){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.indexClient.saveInIndex(r,n);case 2:this.mostRecentlyAccessed=n;t.next=5;return this.sessionManager.set(r,n);case 5:case"end":return t.stop()}}},e,this)}))};i.get=function(n){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.getFromLocalStorage(n);case 2:r=t.sent;if(!r){t.next=6;break}this.mostRecentlyAccessed=r;return t.abrupt("return",r);case 6:t.next=8;return this.getFromIndex(n);case 8:r=t.sent;if(!r){t.next=13;break}this.logger.debug("SID ".concat(n," found in in-index session storage."));this.mostRecentlyAccessed=r;return t.abrupt("return",r);case 13:this.logger.debug("SID ".concat(n," not found in in-index session storage either: giving up."));return t.abrupt("return",null);case 15:case"end":return t.stop()}}},e,this)}))};i.delete=function(e){i.indexClient.deleteFromIndex(e);i.sessionManager.delete(e)};i.reloadSessionsFromIndex=function(){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.indexClient.getSessions();case 2:this.sessionsFromIndex=t.sent;case 3:case"end":return t.stop()}}},e,this)}))};i.checkIfSessionTimeout=function(r){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.isSessionTimeout(r);case 2:if(!t.sent){t.next=5;break}this.delete(r);return t.abrupt("return",true);case 5:return t.abrupt("return",false);case 6:case"end":return t.stop()}}},e,this)}))};i.getFromLocalStorage=function(r){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.sessionManager.get(r);case 2:t.t0=t.sent;if(t.t0){t.next=5;break}t.t0=this.sessionsFromIndex.get(r);case 5:return t.abrupt("return",t.t0);case 6:case"end":return t.stop()}}},e,this)}))};i.getFromIndex=function(n){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.indexClient.getFromIndex(n);case 2:r=t.sent;if(!(r!=null)){t.next=6;break}t.next=6;return this.sessionManager.set(n,r);case 6:return t.abrupt("return",r);case 7:case"end":return t.stop()}}},e,this)}))};i.init=function(){return __awaiter((0,_assertThisInitialized2.default)(i),void 0,void 0,_regenerator.default.mark(function e(){var r=this;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.indexClient.createSessionIndex();case 2:t.next=4;return(0,_lazyUtils.executeWithInterval)(function(){return r.reloadSessionsFromIndex()},this.refreshAfter);case 4:case"end":return t.stop()}}},e,this)}))};i.init();return i}return a}(_sessionManager.SessionManager);exports.IndexBasedSessionManager=IndexBasedSessionManager;