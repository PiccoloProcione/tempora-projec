"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.SessionManager=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var __awaiter=void 0&&(void 0).__awaiter||function(e,s,r,u){function o(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function n(e){try{i(u.next(e))}catch(e){r(e)}}function a(e){try{i(u["throw"](e))}catch(e){r(e)}}function i(e){e.done?t(e.value):o(e.value).then(n,a)}i((u=u.apply(e,s||[])).next())})};var EXCLUDED_SESSION_TIMEOUT_REFRESH_PATHS=['/api/ui_counters/_report','/api/licensing/info'];var SessionManager=function(){function t(){var e=this;(0,_classCallCheck2.default)(this,t);this.mostRecentlyAccessed=null;this.createNewSessionExpirationDate=function(){return new Date(Date.now()+e.sessionTimeoutMillis)};this.getMostRecentlyAccessed=function(){return e.mostRecentlyAccessed};this.exists=function(r){return __awaiter(e,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.get(r);case 2:t.t0=t.sent;return t.abrupt("return",t.t0!=null);case 4:case"end":return t.stop()}}},e,this)}))};this.isSessionExpired=function(n){return __awaiter(e,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.get(n);case 2:r=t.sent;return t.abrupt("return",(r===null||r===void 0?void 0:r.expiresAt.getTime())<Date.now());case 4:case"end":return t.stop()}}},e,this)}))};this.refreshSession=function(i,s){return __awaiter(e,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.get(i);case 2:r=t.sent;if(!(r==null)){t.next=5;break}return t.abrupt("return",null);case 5:n=this.refreshLastSessionActivityDate(r,i,s);a={expiresAt:this.createNewSessionExpirationDate(),lastSessionActivityDate:n,authorizationHeaders:new Map((0,_toConsumableArray2.default)(Array.from(r.authorizationHeaders.entries()))),username:r.username,currentGroup:r.currentGroup,availableGroups:r.availableGroups?(0,_toConsumableArray2.default)(r.availableGroups):[],kibanaHiddenApps:r.kibanaHiddenApps?(0,_toConsumableArray2.default)(r.kibanaHiddenApps):[],kibanaAccess:r.kibanaAccess,kibanaIndex:r.kibanaIndex,kibanaTemplateIndex:r.kibanaTemplateIndex,origin:r.origin};t.next=9;return this.set(i,a);case 9:return t.abrupt("return",a);case 10:case"end":return t.stop()}}},e,this)}))}}(0,_createClass2.default)(t,[{key:"refreshLastSessionActivityDate",value:function e(t,r,n){if(EXCLUDED_SESSION_TIMEOUT_REFRESH_PATHS.includes(n)){return t.lastSessionActivityDate}return new Date}},{key:"lastSessionActivityDate",value:function e(n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.get(n);case 2:r=t.sent;if(r){t.next=5;break}return t.abrupt("return");case 5:return t.abrupt("return",r.lastSessionActivityDate);case 6:case"end":return t.stop()}}},e,this)}))}},{key:"isSessionTimeout",value:function e(i){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=(new Date).getTime();t.next=3;return this.lastSessionActivityDate(i);case 3:n=t.sent;if(n){t.next=6;break}return t.abrupt("return",true);case 6:a=r-n.getTime();return t.abrupt("return",this.sessionTimeoutMillis<a);case 8:case"end":return t.stop()}}},e,this)}))}}]);return t}();exports.SessionManager=SessionManager;