"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.EsClient=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _nodeFetch=_interopRequireDefault(require("node-fetch"));var _authorizationHeaderBuilder=require("./authorization/authorizationHeaderBuilder");var _types=require("./common/types");var _esSecurityHeaderBuilder=require("./common/esSecurityHeaderBuilder");var _lodash=_interopRequireDefault(require("lodash"));var _rorLoggerFactory=require("./logging/rorLoggerFactory");function _createForOfIteratorHelper(r,e){var t;if(typeof Symbol==="undefined"||r[Symbol.iterator]==null){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&typeof r.length==="number"){if(t)r=t;var a=0;var n=function e(){};return{s:n,n:function e(){if(a>=r.length)return{done:true};return{done:false,value:r[a++]}},e:function e(r){throw r},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i=true,s=false,u;return{s:function e(){t=r[Symbol.iterator]()},n:function e(){var r=t.next();i=r.done;return r},e:function e(r){s=true;u=r},f:function e(){try{if(!i&&t.return!=null)t.return()}finally{if(s)throw u}}}}function _unsupportedIterableToArray(e,r){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);if(t==="Object"&&e.constructor)t=e.constructor.name;if(t==="Map"||t==="Set")return Array.from(e);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return _arrayLikeToArray(e,r)}function _arrayLikeToArray(e,r){if(r==null||r>e.length)r=e.length;for(var t=0,a=new Array(r);t<r;t++){a[t]=e[t]}return a}var __awaiter=void 0&&(void 0).__awaiter||function(e,s,t,u){function o(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function a(e){try{i(u.next(e))}catch(e){t(e)}}function n(e){try{i(u["throw"](e))}catch(e){t(e)}}function i(e){e.done?r(e.value):o(e.value).then(a,n)}i((u=u.apply(e,s||[])).next())})};var EsClient=function(){function l(e,r,t){(0,_classCallCheck2.default)(this,l);this.esAuthorizeUserUri='_readonlyrest/metadata/current_user';this.configUri='_readonlyrest/admin/config';this.configFileUri='_readonlyrest/admin/config/file';this.auditLogEventUri='_readonlyrest/admin/audit/event';this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.kibanaTechUserEsCredentials=e;this.authorizationHeaderBuilder=new _authorizationHeaderBuilder.AuthorizationHeaderBuilder;this.esHostBalancer=r;this.esSSLConnectionProvider=t}(0,_createClass2.default)(l,[{key:"authorizeUser",value:function e(i,s){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,a,n;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.prev=0;r.next=3;return this.prepareRequestInit(i,s);case 3:t=r.sent;r.next=6;return this.fetch(this.getElasticsearchUrl()+this.esAuthorizeUserUri,t);case 6:a=r.sent;r.next=9;return a.json();case 9:n=r.sent;this.logger.trace("Authorization attempt returned: ",n);return r.abrupt("return",this.validateSuccessfulAuthorizationResponse(a,n));case 14:r.prev=14;r.t0=r["catch"](0);this.logger.error(r.t0.message,r.t0);throw new Error('Wrong credentials');case 18:case"end":return r.stop()}}},e,this,[[0,14]])}))}},{key:"authorizeUserAttachingMetadata",value:function e(n,i){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,a;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.authorizationHeaderBuilder.prepareAuthorizationHeaderFromMetadata(n,i);case 2:t=r.sent;a=(0,_defineProperty2.default)({},_types.AUTHORIZATION_HEADER,t);r.next=6;return this.fetch(this.getElasticsearchUrl()+this.esAuthorizeUserUri,{headers:a});case 6:return r.abrupt("return",r.sent);case 7:case"end":return r.stop()}}},e,this)}))}},{key:"getAsKibana",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=_esSecurityHeaderBuilder.EsSecurityHeaderBuilder.headerForGetRequestFrom(this.kibanaTechUserEsCredentials);r.next=3;return this.fetch(this.getElasticsearchUrl()+a,{headers:t});case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}},e,this)}))}},{key:"postAsKibana",value:function e(a,n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=_esSecurityHeaderBuilder.EsSecurityHeaderBuilder.headerForPostRequestFrom(this.kibanaTechUserEsCredentials);r.next=3;return this.fetch(this.getElasticsearchUrl()+a,{method:'POST',headers:t,body:n});case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}},e,this)}))}},{key:"headAsKibana",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=_esSecurityHeaderBuilder.EsSecurityHeaderBuilder.headerForGetRequestFrom(this.kibanaTechUserEsCredentials);r.next=3;return this.fetch(this.getElasticsearchUrl()+a,{method:'HEAD',headers:t});case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}},e,this)}))}},{key:"deleteAsKibana",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=_esSecurityHeaderBuilder.EsSecurityHeaderBuilder.headerForGetRequestFrom(this.kibanaTechUserEsCredentials);r.next=3;return this.fetch(this.getElasticsearchUrl()+a,{method:'DELETE',headers:t});case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}},e,this)}))}},{key:"deleteBatchAsKibana",value:function e(o,c){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,a,n,i,s,u;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=[];a=0;n=_createForOfIteratorHelper(_lodash.default.chunk(c,l.BATCH_DELETE_CHUNK_SIZE));r.prev=3;n.s();case 5:if((i=n.n()).done){r.next=25;break}s=i.value;this.logger.debug("Batch-"+a+": deleting "+s.length+" ids: "+JSON.stringify(_lodash.default.take(s,3))+(s.length>1?" etc.":""));r.next=10;return this.postAsKibana(o,JSON.stringify({query:{ids:{values:s}}}));case 10:u=r.sent;if(!(u.status>=300)){r.next=21;break}r.t0=this.logger;r.t1="Batch-"+a+": delete failed with response: ";r.t2=JSON;r.next=17;return u.json();case 17:r.t3=r.sent;r.t4=r.t2.stringify.call(r.t2,r.t3);r.t5=r.t1+r.t4;r.t0.warn.call(r.t0,r.t5);case 21:t.push(u);a++;case 23:r.next=5;break;case 25:r.next=30;break;case 27:r.prev=27;r.t6=r["catch"](3);n.e(r.t6);case 30:r.prev=30;n.f();return r.finish(30);case 33:return r.abrupt("return",t);case 34:case"end":return r.stop()}}},e,this,[[3,27,30,33]])}))}},{key:"putAsKibana",value:function e(n,i){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,a;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=_esSecurityHeaderBuilder.EsSecurityHeaderBuilder.headerForPostRequestFrom(this.kibanaTechUserEsCredentials);r.next=3;return this.fetch(this.getElasticsearchUrl()+n,{method:'PUT',headers:t,body:JSON.stringify(i)});case 3:a=r.sent;r.next=6;return l.toEsResponse(a);case 6:return r.abrupt("return",r.sent);case 7:case"end":return r.stop()}}},e,this)}))}},{key:"getConfiguration",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.fetch(this.getElasticsearchUrl()+this.configUri,{headers:Array.from(a.entries())});case 2:t=r.sent;r.next=5;return l.toEsResponse(t);case 5:return r.abrupt("return",r.sent);case 6:case"end":return r.stop()}}},e,this)}))}},{key:"getConfigurationFile",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.fetch(this.getElasticsearchUrl()+this.configFileUri,{headers:Array.from(a.entries())});case 2:t=r.sent;r.next=5;return l.toEsResponse(t);case 5:return r.abrupt("return",r.sent);case 6:case"end":return r.stop()}}},e,this)}))}},{key:"postAuditEvent",value:function e(a,n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.fetch(this.getElasticsearchUrl()+this.auditLogEventUri,{method:'POST',headers:Array.from(a.entries()).concat([['Content-Type','application/json']]),body:JSON.stringify(n)});case 2:t=r.sent;r.next=5;return l.toEsResponse(t);case 5:return r.abrupt("return",r.sent);case 6:case"end":return r.stop()}}},e,this)}))}},{key:"postConfiguration",value:function e(a,n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.fetch(this.getElasticsearchUrl()+this.configUri,{method:'POST',headers:Array.from(a.entries()).concat([['Content-Type','application/json']]),body:JSON.stringify(n)});case 2:t=r.sent;r.next=5;return l.toEsResponse(t);case 5:return r.abrupt("return",r.sent);case 6:case"end":return r.stop()}}},e,this)}))}},{key:"getElasticsearchUrl",value:function e(){return this.esHostBalancer.getElasticsearchUrl()+"/"}},{key:"prepareRequestInit",value:function e(t,a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:if(!a){r.next=11;break}r.t0=_defineProperty2.default;r.t1={};r.t2=_types.AUTHORIZATION_HEADER;r.next=6;return this.authorizationHeaderBuilder.prepareAuthorizationHeaderFromMetadata(t,a);case 6:r.t3=r.sent;r.t4=(0,r.t0)(r.t1,r.t2,r.t3);return r.abrupt("return",{headers:r.t4});case 11:return r.abrupt("return",{headers:Array.from(t.entries())});case 12:case"end":return r.stop()}}},e,this)}))}},{key:"validateSuccessfulAuthorizationResponse",value:function e(r,t){if(r.status===401||r.status===403){throw new Error("ES Authorization error: ".concat(r.status))}return t}},{key:"fetch",value:function e(t,a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return(0,_nodeFetch.default)(t,Object.assign(Object.assign({},a),{agent:this.esSSLConnectionProvider.getConnectionAgent()}));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}},e,this)}))}}],[{key:"toEsResponse",value:function e(n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,a;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return n.text();case 2:t=r.sent;a=t?JSON.parse(t):t;return r.abrupt("return",{status:n.status,statusMessage:n.statusText,body:a});case 5:case"end":return r.stop()}}},e)}))}}]);return l}();exports.EsClient=EsClient;EsClient.BATCH_DELETE_CHUNK_SIZE=100;