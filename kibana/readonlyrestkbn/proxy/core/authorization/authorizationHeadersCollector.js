"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.AuthorizationHeadersCollector=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var jwt=_interopRequireWildcard(require("jsonwebtoken"));var _types=require("../common/types");var _rorLoggerFactory=require("../logging/rorLoggerFactory");var AuthorizationHeadersCollector=function(){function o(e,r,t,a){(0,_classCallCheck2.default)(this,o);this.authProxy=e;this.requestHeadersWhitelist=r;this.jwtQueryParam=t;this.authSignatureKey=a;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename)}(0,_createClass2.default)(o,[{key:"fromForwardedUserHeader",value:function e(r,t){if(!this.authProxy.enabled){return t}var a=this.authProxy.forward_auth_header;var o=r.getHeaders()[a];if(o){this.logger.debug("Found proxy auth header ".concat(a,": ").concat(o));t.set(a,o)}return t}},{key:"fromJWT",value:function e(r,t){var a=r.getParams()[this.jwtQueryParam.value];if(a){t.set(_types.AUTHORIZATION_HEADER,"Bearer ".concat(a));return t}var o=r.getHeaders()[_types.AUTHORIZATION_HEADER];if((o===null||o===void 0?void 0:o.indexOf("Bearer"))>=0){t.set(_types.AUTHORIZATION_HEADER,o);return t}var i=r.getBody();if(i&&r.getPath().includes("/login")&&r.getMethod()===_types.Method.POST){var s=i[_types.CONNECTOR_SVC_TRANSIENT_JWT];if(s){t.set(_types.AUTHORIZATION_HEADER,"Bearer ".concat(s));var u=jwt.verify(s,this.authSignatureKey)[_types.X_ROR_ORIGIN];if(u){t.set(_types.X_ROR_ORIGIN,u)}}}return t}},{key:"addRequestHeadersWhitelist",value:function e(t,a){this.requestHeadersWhitelist.forEach(function(e){var r=t.getHeaders()[e];if(r){a.set(e,r)}});return a}},{key:"collectCredentialHeaders",value:function e(r){var t=new Map;t=this.addRequestHeadersWhitelist(r,t);t=this.fromForwardedUserHeader(r,t);t=o.fromBasicAuth(r,t);t=this.fromJWT(r,t);t=o.fromConnectorService(r,t);t=o.fromFormJSON(r,t);delete t['cookie'];return t}}],[{key:"fromBasicAuth",value:function e(r,t){var a=r.getHeaders()[_types.AUTHORIZATION_HEADER];if(a===null||a===void 0?void 0:a.includes('Basic')){t.set(_types.AUTHORIZATION_HEADER,a)}return t}},{key:"fromConnectorService",value:function e(r,t){var a=r.getBody();if(a&&r.getMethod()==_types.Method.POST){var o=a[_types.CONNECTOR_SVC_TRANSIENT_JWT];if(o){t.set(_types.AUTHORIZATION_HEADER,"Bearer ".concat(o))}}return t}},{key:"fromFormJSON",value:function e(r,t){var a=r.getBody();if(a&&a['username']){var o=Buffer.from("".concat(a['username'],":").concat(a['password'])).toString('base64');t.set(_types.AUTHORIZATION_HEADER,"Basic ".concat(o))}return t}}]);return o}();exports.AuthorizationHeadersCollector=AuthorizationHeadersCollector;