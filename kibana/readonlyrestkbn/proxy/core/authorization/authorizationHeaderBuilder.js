"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.AuthorizationHeaderBuilder=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _types=require("../common/types");var __awaiter=void 0&&(void 0).__awaiter||function(e,u,t,o){function c(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function a(e){try{i(o.next(e))}catch(e){t(e)}}function n(e){try{i(o["throw"](e))}catch(e){t(e)}}function i(e){e.done?r(e.value):c(e.value).then(a,n)}i((o=o.apply(e,u||[])).next())})};var AuthorizationHeaderBuilder=function(){function o(){(0,_classCallCheck2.default)(this,o)}(0,_createClass2.default)(o,[{key:"prepareAuthorizationHeaderFromRequest",value:function e(n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t,a;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t=n.getIdentitySession().metadata.authorizationHeaders;a=this.collectMetadataFromRequest(n);return r.abrupt("return",this.prepareFrom(t,a));case 3:case"end":return r.stop()}}},e,this)}))}},{key:"prepareAuthorizationHeaderFromMetadata",value:function e(t,a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:return r.abrupt("return",this.prepareFrom(t,[this.inlineGroupHeader(a)]));case 1:case"end":return r.stop()}}},e,this)}))}},{key:"prepareFrom",value:function e(r,t){var a=Array.from(r.entries()).filter(function(e){var r=(0,_slicedToArray2.default)(e,2),t=r[0],a=r[1];return t!=_types.AUTHORIZATION_HEADER}).map(function(e){var r=(0,_slicedToArray2.default)(e,2),t=r[0],a=r[1];return"".concat(t,":").concat(a)});var n=a.concat(t);var i="".concat(o.encodeToBase64(JSON.stringify({headers:n})));var u=r.get(_types.AUTHORIZATION_HEADER)||o.DUMMY_AUTHORIZATION;return"".concat(u,", ror_metadata=").concat(i)}},{key:"collectMetadataFromRequest",value:function e(r){return[this.inlineCurrentGroupHeader(r.getIdentitySession().metadata),this.inlineRequestPath(r),this.inlineRequestMethod(r),this.inlineXForwardedForHeader(r)].filter(function(e){return e!=null})}},{key:"inlineGroupHeader",value:function e(r){return"x-ror-current-group:".concat(r)}},{key:"inlineCurrentGroupHeader",value:function e(r){var t=r===null||r===void 0?void 0:r.currentGroup;if(!t){return null}return"x-ror-current-group:".concat(t)}},{key:"inlineRequestPath",value:function e(r){return"x-ror-kibana-request-path:".concat(r.getPath())}},{key:"inlineRequestMethod",value:function e(r){return"x-ror-kibana-request-method:".concat(r.getMethod())}},{key:"inlineXForwardedForHeader",value:function e(r){var t=r.getHeaders()['x-forwarded-for']||this.getIpFromOriginHeader(r)||r.getOriginAddress();return"x-forwarded-for:".concat(t)}},{key:"getIpFromOriginHeader",value:function e(r){if(!r.getHeaders()['origin']){return undefined}var t=r.getHeaders()['origin'].split("://");return t[1]}}]);return o}();exports.AuthorizationHeaderBuilder=AuthorizationHeaderBuilder;AuthorizationHeaderBuilder.encodeToBase64=function(e){return Buffer.from(e).toString('base64')};AuthorizationHeaderBuilder.DUMMY_AUTHORIZATION="Basic "+AuthorizationHeaderBuilder.encodeToBase64("_:_");