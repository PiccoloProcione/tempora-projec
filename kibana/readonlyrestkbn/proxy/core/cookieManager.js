"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.CookieManager=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _iron=_interopRequireDefault(require("@hapi/iron"));var _rorLoggerFactory=require("./logging/rorLoggerFactory");var __awaiter=void 0&&(void 0).__awaiter||function(e,i,t,u){function l(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function a(e){try{o(u.next(e))}catch(e){t(e)}}function n(e){try{o(u["throw"](e))}catch(e){t(e)}}function o(e){e.done?r(e.value):l(e.value).then(a,n)}o((u=u.apply(e,i||[])).next())})};var CookieManager=function(){function c(e){(0,_classCallCheck2.default)(this,c);this.cookieConfig=e;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename)}(0,_createClass2.default)(c,[{key:"encryptRorCookie",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.prev=0;t={sid:a};r.next=4;return _iron.default.seal(t,this.cookieConfig.password,_iron.default.defaults);case 4:return r.abrupt("return",r.sent);case 7:r.prev=7;r.t0=r["catch"](0);this.logger.error(r.t0);throw r.t0;case 11:case"end":return r.stop()}}},e,this,[[0,7]])}))}},{key:"decryptRorCookieFromHeader",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:if(a){r.next=2;break}return r.abrupt("return",null);case 2:t=this.parseCookieHeader(a)[this.cookieConfig.name];if(t){r.next=5;break}return r.abrupt("return",null);case 5:return r.abrupt("return",this.decryptRorCookie(t));case 6:case"end":return r.stop()}}},e,this)}))}},{key:"decryptRorCookie",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.prev=0;r.next=3;return _iron.default.unseal(a,this.cookieConfig.password,_iron.default.defaults);case 3:t=r.sent;return r.abrupt("return",t["sid"]);case 7:r.prev=7;r.t0=r["catch"](0);this.logger.error(r.t0);return r.abrupt("return",null);case 11:case"end":return r.stop()}}},e,this,[[0,7]])}))}},{key:"parseCookieHeader",value:function e(r){if(!r){return null}var t=r.split('; ');var a=new Map;t.map(function(e){var r=e.split("=");a[r[0]]=r[1]});return a}}],[{key:"getCookiesOptions",value:function e(r){var t,a,n,o;var i=(t=r===null||r===void 0?void 0:r.maxAge)!==null&&t!==void 0?t:c.INFINITE_COOKIE_DURATION_MILLIS;var u=(a=r===null||r===void 0?void 0:r.sameSite)!==null&&a!==void 0?a:"strict";var l=(n=r===null||r===void 0?void 0:r.httpOnly)!==null&&n!==void 0?n:true;var s=(o=r===null||r===void 0?void 0:r.secure)!==null&&o!==void 0?o:true;return{maxAge:i,sameSite:u,httpOnly:l,secure:s}}}]);return c}();exports.CookieManager=CookieManager;CookieManager.INFINITE_COOKIE_DURATION_MILLIS=2147483647*60*1e3;