"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.PreElasticsearchProxy=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _expressHttpProxy=_interopRequireDefault(require("express-http-proxy"));var _express=_interopRequireDefault(require("express"));var _tcpPortUsed=_interopRequireDefault(require("tcp-port-used"));var _interceptionFacade=require("./interceptionFacade");var _morgan=_interopRequireDefault(require("morgan"));var _distributionInfoProvider=require("../../kibana/patchers/distributionInfoProvider");var _esSSLConnectionProvider=require("../core/esSSLConnectionProvider");var _rorLoggerFactory=require("../core/logging/rorLoggerFactory");var _rorRequestAppender=require("../core/rorRequestAppender");var __awaiter=void 0&&(void 0).__awaiter||function(e,o,t,s){function c(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function i(e){try{n(s.next(e))}catch(e){t(e)}}function a(e){try{n(s["throw"](e))}catch(e){t(e)}}function n(e){e.done?r(e.value):c(e.value).then(i,a)}n((s=s.apply(e,o||[])).next())})};var PreElasticsearchProxy=function(){function o(e,r,t,i,a){var n=this;(0,_classCallCheck2.default)(this,o);this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.getElasticsearchUrl=function(){return n.esHostBalancer.getElasticsearchUrl()};this.replaceIndicesInRequestPath=function(t){return __awaiter(n,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.interceptionFacade.replaceIndicesInPath(t.rorRequest);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}},e,this)}))};this.modifyRequestOptions=function(i){return __awaiter(n,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:delete i.headers["cookie"];if(this.shouldAttachMissingKibanaAuthorizationHeader(i)){t="".concat(this.kibanaTechUserEsCredentials.user,":").concat(this.kibanaTechUserEsCredentials.password);i.headers["authorization"]="Basic ".concat(Buffer.from(t).toString('base64'))}if(this.esSSLConnectionProvider.getCertificationType()===_esSSLConnectionProvider.SSLCertificationType.PEM){i.ca=this.esSSLConnectionProvider.getCertificateAuthorities()}if(this.esSSLConnectionProvider.getCertificationType()===_esSSLConnectionProvider.SSLCertificationType.PKC12){i.pfx=this.esSSLConnectionProvider.getTruststore().truststore;i.passphrase=this.esSSLConnectionProvider.getTruststore().password}i.rejectUnauthorized=this.esSSLConnectionProvider.isVerificationEnabled();return r.abrupt("return",i);case 6:case"end":return r.stop()}}},e,this)}))};this.replaceIndicesInRequestBody=function(t,i){return __awaiter(n,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:r.next=2;return this.interceptionFacade.replaceIndicesInBody(t,i.rorRequest);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}},e,this)}))};this.getProxyErrorHandler=function(e,r,t){_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename).trace("PreElasticsearchProxy error ",e);if((e===null||e===void 0?void 0:e.code)==="ECONNREFUSED"){r.status(503).send("Elasticsearch host ".concat(n.getElasticsearchUrl()," is unavailable"));return}t(e)};this.app=(0,_express.default)();this.interceptionFacade=new _interceptionFacade.InterceptionFacade(e,a.kibanaIndex,a.reportingIndex);this.esHostBalancer=t;this.esSSLConnectionProvider=i;this.rorRequestAppender=r;this.kibanaTechUserEsCredentials=a.kibanaTechUserEsCredentials;this.networkParameters=a.networkParameters;this.init(a.port,a.kibanaIndex,e)}(0,_createClass2.default)(o,[{key:"close",value:function e(){this.server.close()}},{key:"init",value:function e(r,i,a){var n=this;this.app.disable('x-powered-by');this.app.use(function(e,r,t){n.replaceKibanaIndex(e,i,a);return t()});this.app.use(_rorRequestAppender.RorRequestAppender.appendRorRequest);this.app.use(this.rorRequestAppender.appendIdentitySession);this.initDevInterceptors();this.app.use((0,_expressHttpProxy.default)(this.getElasticsearchUrl,this.getProxyOptions()));this.launchProxyServer(r)}},{key:"initDevInterceptors",value:function e(){if(_distributionInfoProvider.DistributionInfoProvider.isEnvironmentDev()){this.app.use((0,_morgan.default)('PEP :method :url :status :response-time ms - :res[content-length]'))}}},{key:"getProxyOptions",value:function e(){return{https:false,preserveHostHdr:false,parseReqBody:true,limit:"50gb",memoizeHost:false,proxyReqPathResolver:this.replaceIndicesInRequestPath,proxyReqOptDecorator:this.modifyRequestOptions,proxyReqBodyDecorator:this.replaceIndicesInRequestBody,proxyErrorHandler:this.getProxyErrorHandler,timeout:this.networkParameters.requestTimeout}}},{key:"shouldAttachMissingKibanaAuthorizationHeader",value:function e(r){var t,i;var a=r.path.includes('/_bulk');var n=r.headers["authorization"]==null&&r.path.includes('/_search')&&r.method==='POST'&&((t=r.headers["user-agent"])===null||t===void 0?void 0:t.toString())===undefined;var o=r.headers["authorization"]==null&&((i=r.headers["user-agent"])===null||i===void 0?void 0:i.toString().includes("elasticsearch-js"));var s=r.path.includes('/_data_stream');var c=r.path.includes('/_index_template');var u=r.path.includes('/_component_template');if(n){this.logger.debug("Missing kibana authorization header added into a ".concat(r.path," search in indexes request"))}if(o){this.logger.trace("Missing kibana authorization header added into a ".concat(r.path," es client direct request"))}if(a){this.logger.debug("Missing kibana authorization header added into a ".concat(r.path," bulk request"))}if(s){this.logger.debug("Missing kibana authorization header added into a ".concat(r.path," index management data streams request"))}if(c){this.logger.debug("Missing kibana authorization header added into a ".concat(r.path," index management template request"))}if(u){this.logger.debug("Missing kibana authorization header added into a ".concat(r.path," index management component template request"))}return o||n||a||s||c||u}},{key:"launchProxyServer",value:function e(i){var r=this;var a='127.0.0.1';_tcpPortUsed.default.check(i,a).then(function(t){return __awaiter(r,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:if(t){r.next=5;break}this.logger.info("Pre-Elasticsearch-proxy will listen on ".concat(a,":").concat(i));r.next=4;return this.app.listen(i,a);case 4:this.server=r.sent;case 5:case"end":return r.stop()}}},e,this)}))})}},{key:"replaceKibanaIndex",value:function e(r,t,i){var a;var n=_distributionInfoProvider.DistributionInfoProvider.getInstance().kibanaVersion;var o="".concat(t,"_").concat(n);var s=(a=i.getMostRecentlyAccessed())===null||a===void 0?void 0:a.kibanaIndex;var c=s&&"".concat(s,"_").concat(n);r.url=this.getReplacedUrl(r.url,o,c)}},{key:"getReplacedUrl",value:function e(r,t,i){var a=r.match(/\b\/alert\b/gi);var n=r.match(/\b\/action\b/gi);var o=a||n;if(i&&r.includes(t)&&o){this.logger.trace("".concat(t," kibana index is replaced into a ").concat(i," in a ").concat(r));return r.replace(t,i)}return r}}]);return o}();exports.PreElasticsearchProxy=PreElasticsearchProxy;