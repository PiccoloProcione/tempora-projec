"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.LogoutLinkProvider=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _types=require("../../core/common/types");var _rorLoggerFactory=require("../../core/logging/rorLoggerFactory");var LogoutLinkProvider=function(){function a(e,t,i,r,o){var n=this;(0,_classCallCheck2.default)(this,a);this.kibanaBasePath=e;this.samlRouterConfigs=t;this.oidcRouterConfigs=i;this.customLogoutLink=r;this.proxyAuthConfig=o;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.withBasePath=function(e){return n.kibanaBasePath+e}}(0,_createClass2.default)(a,[{key:"buildLogoutLink",value:function e(t){var i=t===null||t===void 0?void 0:t.origin;if(i){var r=this.samlRouterConfigs.find(function(e){return e.connectorName==i});if(r){return r.logoutPathRelativeToRoot()}var o=this.oidcRouterConfigs.find(function(e){return e.connectorName==i});if(o){return o.logoutPathRelativeToRoot()}}if(this.customLogoutLink==null){return this.buildLoginLink(t)}return this.buildCustomLogoutLink(t)}},{key:"buildLoginLink",value:function e(t){return this.buildDefaultLoginLink(this.proxyAuthConfig.enabled&&this.isProxyAuthHeaderSupplied(t))}},{key:"isProxyAuthHeaderSupplied",value:function e(t){return(t===null||t===void 0?void 0:t.authorizationHeaders.get(this.proxyAuthConfig.forward_auth_header))!=null}},{key:"buildDefaultLoginLink",value:function e(t){return this.withBasePath(t?"/login?".concat(_types.AUTOLOGIN_QUERY_PARAM,"=false"):'/login')}},{key:"buildCustomLogoutLink",value:function e(t){var i=t===null||t===void 0?void 0:t.origin;var r=this.replaceIdentityVariables(t);var o=new URL(r.includes("://")?r:"http://".concat(r));if(o.searchParams.has(_types.X_ROR_ORIGIN)){return o.toString()}!!i?o.searchParams.set(_types.X_ROR_ORIGIN,i):o.searchParams.set(_types.X_ROR_ORIGIN,a.CUSTOM_LOGOUT_LINK_PARAM_VALUE);return o.toString()}},{key:"replaceIdentityVariables",value:function e(t){var n=this;this.logger.trace("Beginning to replace identity variables in the custom logout url");if(!this.customLogoutLink.includes("@{identity")||!t){this.logger.debug("No identity variables found in the custom logout url or identity session metadata is empty");return this.customLogoutLink}var a=this.customLogoutLink;Object.entries(t).forEach(function(e){var t=(0,_slicedToArray2.default)(e,2),i=t[0],r=t[1];if(r){var o=JSON.stringify(r);n.logger.trace("Replacing @{identity:".concat(i,"} with ").concat(o));a=a.replace("@{identity:".concat(i,"}"),o)}});this.logger.debug("Replaced identity variables. The new logout url is: ".concat(a));return a}}]);return a}();exports.LogoutLinkProvider=LogoutLinkProvider;LogoutLinkProvider.CUSTOM_LOGOUT_LINK_PARAM_VALUE="custom_logout_link";