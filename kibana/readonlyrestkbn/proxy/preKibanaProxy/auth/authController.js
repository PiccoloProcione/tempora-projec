"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.AuthController=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _rorRequestCreator=require("../../core/rorRequest/rorRequestCreator");var _rorLoggerFactory=require("../../core/logging/rorLoggerFactory");var _types=require("../../core/common/types");var _cookieManager=require("../../core/cookieManager");var _identitySession=require("../../core/identitySession");var __awaiter=void 0&&(void 0).__awaiter||function(e,o,r,s){function u(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function n(e){try{i(s.next(e))}catch(e){r(e)}}function a(e){try{i(s["throw"](e))}catch(e){r(e)}}function i(e){e.done?t(e.value):u(e.value).then(n,a)}i((s=s.apply(e,o||[])).next())})};var AuthController=function(){function u(e,t,r,n,a,i,o,s){var l=this;(0,_classCallCheck2.default)(this,u);this.kibanaBasePath=e;this.proxyAuth=t;this.authenticationFacade=r;this.logoutLinkProvider=n;this.auditLogEmitter=a;this.cookieConfig=i;this.probeIntervalMillis=o;this.customLoginLink=s;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.handleProxyAuth=function(s,u,c){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a,i,o;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(!s.rorRequest.isAuthenticated()){t.next=2;break}return t.abrupt("return",c());case 2:r=s.headers[this.proxyAuth.forward_auth_header];if(!(r==null)){t.next=5;break}return t.abrupt("return",c());case 5:t.prev=5;t.next=8;return this.authenticationFacade.authorizeRequest(s.rorRequest);case 8:n=t.sent;a=(0,_slicedToArray2.default)(n,2);i=a[0];o=a[1];s.rorRequest.setIdentitySession(o);u.cookie(this.cookieConfig.name,i,_cookieManager.CookieManager.getCookiesOptions({secure:this.cookieConfig.secure}));t.next=19;break;case 16:t.prev=16;t.t0=t["catch"](5);this.logger.info("Could not authorize through proxy header: + "+t.t0.message);case 19:c();case 20:case"end":return t.stop()}}},e,this,[[5,16]])}))};this.redirectAuthenticated=function(r,n,a){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(!(r.query&&r.query[_types.AUTOLOGIN_QUERY_PARAM]==='false')){t.next=3;break}a();return t.abrupt("return");case 3:t.next=5;return r.rorRequest.isAuthenticated();case 5:if(!t.sent){t.next=8;break}n.redirect(this.getNextUrl(r)||this.withBasePath("/"));return t.abrupt("return");case 8:a();case 9:case"end":return t.stop()}}},e,this)}))};this.handleCustomLoginRedirection=function(e,r,n){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(!(this.customLoginLink!=null)){t.next=3;break}r.redirect(this.customLoginLink);return t.abrupt("return");case 3:n();case 4:case"end":return t.stop()}}},e,this)}))};this.handleAuthentication=function(o,e,s,u){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a,i;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:o.rorRequest=_rorRequestCreator.RorRequestCreator.fromExpressRequest(o);t.prev=1;t.next=4;return this.authenticationFacade.authorizeRequest(o.rorRequest);case 4:r=t.sent;n=(0,_slicedToArray2.default)(r,2);a=n[0];i=n[1];if(i.metadata.username){t.next=10;break}throw new Error('Empty metadata');case 10:return t.abrupt("return",s(a,i));case 13:t.prev=13;t.t0=t["catch"](1);return t.abrupt("return",u(t.t0));case 16:case"end":return t.stop()}}},e,this,[[1,13]])}))};this.handleLoginPost=function(i,o){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var n=this;var r,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=function e(t){var r=n.getNextUrl(i)||n.withBasePath("/");o.clearCookie(_types.NEXT_URL);o.cookie(n.cookieConfig.name,t,_cookieManager.CookieManager.getCookiesOptions({secure:n.cookieConfig.secure}));o.setHeader('Content-Type','application/json');return o.json({nextUrl:r})};a=function e(t){o.status(401);o.setHeader('Content-Type','application/json');n.logger.info("Could not login in: "+t.message);return o.json({message:t.message})};t.next=4;return this.handleAuthentication(i,o,r,a);case 4:case"end":return t.stop()}}},e,this)}))};this.handleApiReqWithCredentialsOnboard=function(i,o,s){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var n=this;var r,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(!(i.path.indexOf("/api/")<0||i.rorRequest.isCookiePresent(this.cookieConfig.name))){t.next=2;break}return t.abrupt("return",s());case 2:r=function e(t,r){o.cookie(n.cookieConfig.name,t,_cookieManager.CookieManager.getCookiesOptions({secure:n.cookieConfig.secure}));i.rorRequest.setIdentitySession(r);return s()};a=function e(t){o.status(401);o.setHeader('Content-Type','application/json');n.logger.info("Could not authenticate: "+t.message);return o.json({message:t.message})};t.next=6;return this.handleAuthentication(i,o,r,a);case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}},e,this)}))};this.handleLogout=function(a,i){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var r,n;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=this.getLogoutRedirectUrl(a.rorRequest);n=u.setNextUrlParam(r,this.getNextUrl(a));t.next=4;return this.authenticationFacade.clearSession(a.rorRequest);case 4:t.next=6;return this.handleLogoutEvent(a.rorRequest);case 6:a.rorRequest.setIdentitySession(null);i.clearCookie(this.cookieConfig.name);i.redirect(n);case 9:case"end":return t.stop()}}},e,this)}))};this.handleSessionProbe=function(o,s){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a,i;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:s.setHeader('Content-Type','application/json');r=o.rorRequest;if(r.isAuthenticated()){t.next=6;break}s.status(401);s.json({message:'No valid session'});return t.abrupt("return");case 6:t.next=8;return this.authenticationFacade.verifySessionTimeout(r);case 8:n=t.sent;if(!n){t.next=14;break}this.logger.info('Session timeout');s.status(401);s.json({message:'Session timeout'});return t.abrupt("return");case 14:t.prev=14;this.logger.info("Refreshing session against ES");a=r.getIdentitySession();t.next=19;return this.authenticationFacade.refreshSessionAgainstEs(a);case 19:i=t.sent;return t.abrupt("return",this.handleNewSession(a,i,s));case 23:t.prev=23;t.t0=t["catch"](14);this.logger.info("Could not refresh the session against ES: + "+t.t0.message);s.status(401);s.json({message:'Session no longer valid'});return t.abrupt("return");case 29:case"end":return t.stop()}}},e,this,[[14,23]])}))};this.redirectUnauthenticated=function(a,i,o){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){var r,n;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(a.rorRequest.isAuthenticated()){t.next=5;break}r=this.withBasePath("/logout");n=u.setNextUrlParam(r,a.originalUrl);i.redirect(n);return t.abrupt("return");case 5:o();return t.abrupt("return");case 7:case"end":return t.stop()}}},e,this)}))};this.refreshSession=function(r,e,n){return __awaiter(l,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.authenticationFacade.refreshSession(r.rorRequest);case 2:n();return t.abrupt("return");case 4:case"end":return t.stop()}}},e,this)}))};this.withBasePath=function(e){return l.kibanaBasePath+e}}(0,_createClass2.default)(u,[{key:"handleNewSession",value:function e(t,r,n){if(_identitySession.IdentitySessionMetadataDifferenceChecker.isDifferent(t.metadata,r.metadata)){this.logger.info("Significant session change detected");this.logger.debug("Current sessionMetadata: ".concat(JSON.stringify(t.metadata)));this.logger.debug("New sessionMetadata: ".concat(JSON.stringify(r.metadata)));n.status(200);n.json({message:'Session updated',reload:true,intervalMillis:this.probeIntervalMillis});return}n.status(200);n.json({message:'Session valid',reload:false,intervalMillis:this.probeIntervalMillis});return}},{key:"handleLogoutEvent",value:function e(n){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=n.getParams()[_types.X_ROR_ORIGIN]||'N/A';if(!n.isAuthenticated()){t.next=4;break}t.next=4;return this.auditLogEmitter.emitLogoutEvent(n.getAuthorizationHeaders(),r);case 4:case"end":return t.stop()}}},e,this)}))}},{key:"getLogoutRedirectUrl",value:function e(t){var r=t.getIdentitySession();var n=r===null||r===void 0?void 0:r.metadata;return this.logoutLinkProvider.buildLogoutLink(n)}},{key:"getNextUrl",value:function e(t){var r=t.query&&t.query[_types.NEXT_URL];if(!r||r.indexOf("ror_kbn_sso")>=0||r.indexOf("/logout")>=0){return null}var n=r==='/'||r==='';if(n){r=this.withBasePath(r)}this.logger.trace("NextUrl in param: "+r);return r}}],[{key:"setNextUrlParam",value:function e(t,r){if(r!=null){var n=encodeURIComponent(r);if(t.includes("?")){return"".concat(t,"&").concat(_types.NEXT_URL,"=").concat(n)}else{return"".concat(t,"?").concat(_types.NEXT_URL,"=").concat(n)}}return t}}]);return u}();exports.AuthController=AuthController;