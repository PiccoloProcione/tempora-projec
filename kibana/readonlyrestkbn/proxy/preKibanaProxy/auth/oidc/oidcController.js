"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.OidcController=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _types=require("../../../core/common/types");var _rorLoggerFactory=require("../../../core/logging/rorLoggerFactory");var OidcController=function(){function t(e,r,o){var n=this;(0,_classCallCheck2.default)(this,t);this.config=e;this.jwtSigner=r;this.legacyRenderer=o;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.onLoginCallback=function(e,r){var o=e.user["_json"][n.config.usernameParameter];n.logger.debug('Obtained user name from profile: '+o);var t=n.getGroups(e.user);n.logger.debug('Obtained groups from profile: '+t);var a=n.createJWT(o,t,e.user);var i=n.legacyRenderer.renderJwtRedirect(a);r.send(i)};this.onLogout=function(e,r){var o=JSON.stringify(e.user);n.logger.trace("Logout called for user: ".concat(o));e.logout();var t=n.config.oidcLogoutUrl+"?redirect_uri=".concat(n.config.logoutCallBackUrl);n.logger.trace("Logout called for user: ".concat(o,". redirecting to ").concat(t));return r.redirect(t)};this.onLogoutCallback=function(e,r){var o=JSON.stringify(e.user);n.logger.trace("Logout callback called for user: ".concat(o));e.logout();r.clearCookie(n.config.cookieConfig.name,{path:'/'});n.logger.trace("Logout called for user: ".concat(o,". redirecting to ").concat(n.config.logoutPath));r.send(n.legacyRenderer.renderRedirect(n.config.logoutPath))}}(0,_createClass2.default)(t,[{key:"getGroups",value:function e(r){var o=r["_json"][this.config.groupsParameter];if(!o){return[]}if(typeof o=='string'){return o.split(",")}return Object.assign([],o)}},{key:"createJWT",value:function e(r,o,t){var a=Object.assign({},t["_json"]);delete a[this.config.groupsParameter];var i=(0,_defineProperty2.default)({user:r,groups:o,assertion:a},_types.X_ROR_ORIGIN,this.config.connectorName);this.logger.debug("Created JWT for ROR with claims: ".concat(JSON.stringify(i)));return this.jwtSigner.sign(i)}}]);return t}();exports.OidcController=OidcController;