"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.AuthenticationFacade=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _v=_interopRequireDefault(require("uuid/v4"));var _defaultSpaceCreator=require("./defaultSpaceCreator");var _rorLoggerFactory=require("../core/logging/rorLoggerFactory");var _indexCreatorFactory=require("./indexCreation/indexCreatorFactory");var __awaiter=void 0&&(void 0).__awaiter||function(e,s,r,o){function u(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function a(e){try{i(o.next(e))}catch(e){r(e)}}function n(e){try{i(o["throw"](e))}catch(e){r(e)}}function i(e){e.done?t(e.value):u(e.value).then(a,n)}i((o=o.apply(e,s||[])).next())})};var AuthenticationFacade=function(){function o(e,t,r,a,n,i,s){(0,_classCallCheck2.default)(this,o);this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.esClient=a;this.sessionManager=e;this.cookieManager=t;this.defaultSpaceCreator=new _defaultSpaceCreator.DefaultSpaceCreator(r,this.esClient);this.indexCreator=_indexCreatorFactory.IndexCreatorFactory.create(r,a,i,s);this.authorizationHeadersCollector=n}(0,_createClass2.default)(o,[{key:"authorizeRequest",value:function e(s){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,a,n,i;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=this.authorizationHeadersCollector.collectCredentialHeaders(s);t.next=3;return this.esClient.authorizeUser(r);case 3:a=t.sent;t.next=6;return this.createIdentitySession(r,a,s.lastSessionActivityDate);case 6:n=t.sent;t.next=9;return this.createIndexAndSpace(n.metadata);case 9:t.next=11;return this.cookieManager.encryptRorCookie(n.sid);case 11:i=t.sent;return t.abrupt("return",[i,n]);case 13:case"end":return t.stop()}}},e,this)}))}},{key:"clearSession",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.cookieManager.decryptRorCookieFromHeader(a.getCookies());case 2:r=t.sent;if(r){this.sessionManager.delete(r)}case 4:case"end":return t.stop()}}},e,this)}))}},{key:"refreshSession",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=a.getIdentitySession().sid;t.next=3;return this.sessionManager.refreshSession(r,a.getUrl());case 3:a.getIdentitySession().metadata=t.sent;case 4:case"end":return t.stop()}}},e,this)}))}},{key:"refreshSessionAgainstEs",value:function e(s){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,a,n,i;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=s.metadata.authorizationHeaders;a=s.metadata.currentGroup;t.next=4;return this.esClient.authorizeUser(r,a);case 4:n=t.sent;i=this.buildIdentitySessionMetadata(r,n,s.metadata.lastSessionActivityDate);t.next=8;return this.sessionManager.set(s.sid,i);case 8:return t.abrupt("return",{sid:s.sid,metadata:i});case 9:case"end":return t.stop()}}},e,this)}))}},{key:"switchGroups",value:function e(u){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,a,n,i,s,o;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=u.getIdentitySession();a=new URL(u.getUrl(),"http://localhost:5601").searchParams.get("group");n=decodeURIComponent(a);i=r.metadata.authorizationHeaders;t.next=6;return this.authorizeAttachingHeaders(i,n,u.lastSessionActivityDate);case 6:s=t.sent;this.sessionManager.delete(r.sid);t.next=10;return this.sessionManager.get(s);case 10:o=t.sent;if(!(o==null)){t.next=14;break}this.logger.info("Unsuccessful tenancy switch. Failed to retrieve IdentitySessionMetadata");return t.abrupt("return",null);case 14:t.next=16;return this.createIndexAndSpace(o);case 16:u.setIdentitySession({sid:s,metadata:o});t.next=19;return this.cookieManager.encryptRorCookie(s);case 19:return t.abrupt("return",t.sent);case 20:case"end":return t.stop()}}},e,this)}))}},{key:"verifySessionTimeout",value:function e(a){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=a.getIdentitySession().sid;t.next=3;return this.sessionManager.checkIfSessionTimeout(r);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}},e,this)}))}},{key:"createIndexAndSpace",value:function e(r){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(!r.kibanaIndex){t.next=5;break}t.next=3;return this.indexCreator.createIndexIfNecessary(r.kibanaIndex,r.kibanaTemplateIndex);case 3:t.next=5;return this.defaultSpaceCreator.createDefaultSpaceDocumentIfNeeded(r.kibanaIndex);case 5:case"end":return t.stop()}}},e,this)}))}},{key:"authorizeAttachingHeaders",value:function e(a,n,i){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r=this;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:return t.abrupt("return",this.esClient.authorizeUserAttachingMetadata(a,n).then(function(e){return e.json()}).then(function(e){return r.createIdentitySession(a,e,i)}).then(function(e){return e.sid}).catch(this.onError));case 1:case"end":return t.stop()}}},e,this)}))}},{key:"createIdentitySession",value:function e(n,i,s){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,a;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:r=(0,_v.default)();a=this.buildIdentitySessionMetadata(n,i,s);t.next=4;return this.sessionManager.set(r,a);case 4:return t.abrupt("return",{sid:r,metadata:a});case 5:case"end":return t.stop()}}},e,this)}))}},{key:"buildIdentitySessionMetadata",value:function e(t,r,a){var n={expiresAt:this.sessionManager.createNewSessionExpirationDate(),lastSessionActivityDate:a,authorizationHeaders:t,username:r["x-ror-username"],availableGroups:[],kibanaHiddenApps:[],kibanaAccess:r["x-ror-kibana_access"],kibanaIndex:r["x-ror-kibana_index"],kibanaTemplateIndex:r["x-ror-kibana_template_index"],origin:r["x-ror-origin"]};n['availableGroups']=r["x-ror-available-groups"]||[];n['currentGroup']=r["x-ror-current-group"]||undefined;n["kibanaHiddenApps"]=r["x-ror-kibana-hidden-apps"]||[];return n}},{key:"onError",value:function e(t){_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename).error(t);return null}}]);return o}();exports.AuthenticationFacade=AuthenticationFacade;