"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.ProxyBuilder=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _expressHttpProxy=_interopRequireDefault(require("express-http-proxy"));var _authorizationHeaderBuilder=require("../core/authorization/authorizationHeaderBuilder");var _rorLoggerFactory=require("../core/logging/rorLoggerFactory");var _kibanaAppsRegistry=require("./kibana_apps/kibanaAppsRegistry");var _CapabilitiesApiFilter=require("./injection/capabilities/CapabilitiesApiFilter");var __awaiter=void 0&&(void 0).__awaiter||function(e,o,t,u){function s(r){return r instanceof t?r:new t(function(e){e(r)})}return new(t||(t=Promise))(function(r,t){function i(e){try{n(u.next(e))}catch(e){t(e)}}function a(e){try{n(u["throw"](e))}catch(e){t(e)}}function n(e){e.done?r(e.value):s(e.value).then(i,a)}n((u=u.apply(e,o||[])).next())})};var ProxyBuilder=function(){function o(e,r,t){var n=this;(0,_classCallCheck2.default)(this,o);this.authorizationHeaderDecorator=function(t,i){return __awaiter(n,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(r){while(1){switch(r.prev=r.next){case 0:t.headers["x-ror-pkp-kibana-token"]=this.pkpKibanaToken;r.next=3;return this.authorizationHeaderBuilder.prepareAuthorizationHeaderFromRequest(i.rorRequest);case 3:t.headers["Authorization"]=r.sent;return r.abrupt("return",t);case 5:case"end":return r.stop()}}},e,this)}))};this.interceptResponse=function(e,r,t,i){if(_CapabilitiesApiFilter.CapabilitiesApiFilter.shouldInterceptRequestBody(t)){return _CapabilitiesApiFilter.CapabilitiesApiFilter.interceptRequestBody(t,r)}if(o.isResponseValidHTML(e,r)){var a=o.extractHiddenAppsNames(t.rorRequest);if(!_kibanaAppsRegistry.KibanaAppsRegistry.isNavigationAllowed(t.path,a)){o.logger.info("Attempted navigation to prohibited path ".concat(t.path));i.redirect("/");return r}return n.htmlInjector.injectCssAndJsScriptsIntoHtml(r)}return r};this.proxyErrorHandler=function(e,r,t){o.logger.trace("PreKibanaProxy error ",e);t(e)};this.kibanaUrl=e;this.pkpKibanaToken=r;this.authorizationHeaderBuilder=new _authorizationHeaderBuilder.AuthorizationHeaderBuilder;this.htmlInjector=t}(0,_createClass2.default)(o,[{key:"build",value:function e(){var i=this;var a=function e(r){var t=r.headers["content-type"];return(t===null||t===void 0?void 0:t.indexOf("multipart"))>-1};return function(e,r,t){return(0,_expressHttpProxy.default)(i.kibanaUrl,{parseReqBody:!a(e),https:false,preserveHostHdr:true,proxyReqOptDecorator:i.authorizationHeaderDecorator,userResDecorator:i.interceptResponse,proxyErrorHandler:i.proxyErrorHandler})(e,r,t)}}}],[{key:"isResponseValidHTML",value:function e(r,t){return r.headers['content-type']&&r.headers['content-type'].toString().includes("html")&&t.toString().includes("<head>")&&t.toString().includes("<body>")}},{key:"extractHiddenAppsNames",value:function e(r){var t=r.getIdentitySession().metadata.kibanaHiddenApps;if(t&&t.length>=0){return t}return[]}}]);return o}();exports.ProxyBuilder=ProxyBuilder;ProxyBuilder.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);