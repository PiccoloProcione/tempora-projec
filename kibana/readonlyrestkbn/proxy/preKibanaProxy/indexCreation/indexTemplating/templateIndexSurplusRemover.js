"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.TemplateIndexSurplusRemover=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _rorLoggerFactory=require("../../../core/logging/rorLoggerFactory");var __awaiter=void 0&&(void 0).__awaiter||function(e,u,r,a){function s(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function n(e){try{i(a.next(e))}catch(e){r(e)}}function o(e){try{i(a["throw"](e))}catch(e){r(e)}}function i(e){e.done?t(e.value):s(e.value).then(n,o)}i((a=a.apply(e,u||[])).next())})};var TemplateIndexSurplusRemover=function(){function t(e){var r=this;(0,_classCallCheck2.default)(this,t);this.esClient=e;this.logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);this.verifyDocumentExistsIn=function(e){return function(t){return r.esClient.headAsKibana("".concat(e,"/_doc/").concat(t)).then(function(e){return e.status}).then(function(e){return{id:t,exists:e===200}})}}}(0,_createClass2.default)(t,[{key:"removeFromTargetDocumentsMissingInTemplate",value:function e(o,i,u){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,n;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:this.logger.info("Looking for documents present in '".concat(i,"' but not in template index"));t.next=3;return this.retrieveAllDocumentsFrom(i);case 3:r=t.sent;t.next=6;return this.identifySurplus(o,i,r,u);case 6:n=t.sent;return t.abrupt("return",this.removeSurplusFrom(i,n));case 8:case"end":return t.stop()}}},e,this)}))}},{key:"retrieveAllDocumentsFrom",value:function e(t){var r=this;return this.esClient.getAsKibana("".concat(t,"/_search")).then(function(e){return e.json()}).then(function(e){r.logger.trace("Response: ",e);return e}).then(function(e){return e.hits.hits.map(function(e){return e._id})})}},{key:"identifySurplus",value:function e(r,n,o,i){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:if(!(o.length===r)){t.next=3;break}this.logger.info("All documents in '".concat(i,"' match documents in '").concat(n,"'. Nothing to remove."));return t.abrupt("return",Promise.resolve([]));case 3:this.logger.info("Target '".concat(n,"' contains ").concat(o.length," documents but '").concat(i,"' contains ").concat(r,". Need to delete surplus."));return t.abrupt("return",Promise.all(o.map(this.verifyDocumentExistsIn(i))).then(function(e){return e.filter(function(e){return!e.exists}).map(function(e){return e.id})}));case 5:case"end":return t.stop()}}},e,this)}))}},{key:"removeSurplusFrom",value:function e(t,r){var n=this;Promise.all(r.map(function(e){n.logger.debug("Deleting document with id: '".concat(e,"'"));return n.esClient.deleteAsKibana("".concat(t,"/_doc/").concat(e))}))}}]);return t}();exports.TemplateIndexSurplusRemover=TemplateIndexSurplusRemover;