"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.Post_7_12_0_IndexCreator=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _indexCreator=require("./indexCreator");function _createSuper(a){var i=_isNativeReflectConstruct();return function e(){var t=(0,_getPrototypeOf2.default)(a),r;if(i){var n=(0,_getPrototypeOf2.default)(this).constructor;r=Reflect.construct(t,arguments,n)}else{r=t.apply(this,arguments)}return(0,_possibleConstructorReturn2.default)(this,r)}}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true}catch(e){return false}}var __awaiter=void 0&&(void 0).__awaiter||function(e,u,r,o){function s(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,r){function n(e){try{i(o.next(e))}catch(e){r(e)}}function a(e){try{i(o["throw"](e))}catch(e){r(e)}}function i(e){e.done?t(e.value):s(e.value).then(n,a)}i((o=o.apply(e,u||[])).next())})};var Post_7_12_0_IndexCreator=function(e){(0,_inherits2.default)(c,e);var i=_createSuper(c);function c(e,t,r,n){var a;(0,_classCallCheck2.default)(this,c);a=i.call(this,e,t,__filename,r,n);a.defaultKibanaIndex=e;a.esClient=t;return a}(0,_createClass2.default)(c,[{key:"createKibanaIndex",value:function e(l){return __awaiter(this,void 0,void 0,_regenerator.default.mark(function e(){var r,n,a,i,u,o,s;return _regenerator.default.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return this.getDefaultIndexMapping();case 2:r=t.sent;n=Object.keys(r)[0];a=r[n].mappings;i={mappings:{properties:a.properties}};u=n.split(this.defaultKibanaIndex).join(l);o=c.getShortFormAlias(u);this.logger.debug("Discovered Kibana >= 7.12.0 index migration algorithm in use. Will create the index ".concat(u," with aliases: ").concat(o));if(o){i['aliases']=(s={},(0,_defineProperty2.default)(s,l,{}),(0,_defineProperty2.default)(s,o,{}),s)}this.logger.debug("kibana_index resolution: default=".concat(this.defaultKibanaIndex,", fromSession=").concat(l,", willBeCreated=").concat(u));this.logger.debug("Creating kibana index ".concat(l," with mappings from ").concat(this.defaultKibanaIndex,": PUT ").concat(JSON.stringify(i).substring(0,50),"..."));t.next=14;return this.esClient.putAsKibana(u,i);case 14:case"end":return t.stop()}}},e,this)}))}}],[{key:"getShortFormAlias",value:function e(t){var r=c.getPost712KibanaIndexSuffix(t);if(!r){return null}return t.substring(0,t.length-r.length)}},{key:"getPost712KibanaIndexSuffix",value:function e(t){var r=t.match(c.POST_7_12_KIBANA_INDEX_SUFFIX);return r?r[0]:null}}]);return c}(_indexCreator.IndexCreator);exports.Post_7_12_0_IndexCreator=Post_7_12_0_IndexCreator;Post_7_12_0_IndexCreator.POST_7_12_KIBANA_INDEX_SUFFIX=/_[0-9][0-9][0-9]$/;