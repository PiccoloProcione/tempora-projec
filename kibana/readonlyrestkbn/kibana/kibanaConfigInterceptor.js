"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.onKibanaConfigParse=onKibanaConfigParse;var _=_interopRequireWildcard(require("lodash"));var _preKibanaProxy=require("../proxy/preKibanaProxy/preKibanaProxy");var _preElasticsearchProxy=require("../proxy/preElasticsearchProxy/preElasticsearchProxy");var _esClient=require("../proxy/core/esClient");var _esHostBalancer=require("../proxy/core/esHostBalancer");var _esSSLConnectionProvider=require("../proxy/core/esSSLConnectionProvider");var _sessionManagerFactory=require("../proxy/core/sessionManager/sessionManagerFactory");var _kibanaYamlLogLevelParser=require("./config/kibanaYamlLogLevelParser");var _rorLoggerFactory=require("../proxy/core/logging/rorLoggerFactory");var _rorRequestAppender=require("../proxy/core/rorRequestAppender");var _cookieManager=require("../proxy/core/cookieManager");var _kibanaYamlElasticsearchConfigParser=require("./config/kibanaYamlElasticsearchConfigParser");var _kibanaYamlKibanaConfigParser=require("./config/kibanaYamlKibanaConfigParser");var _kibanaYamlRorConfigParser=require("./config/kibanaYamlRorConfigParser");var _rorStoreInitializer=require("./config/rorStoreInitializer");var _unsupportedFeaturesNotifier=require("./config/unsupportedFeaturesNotifier");var _configUtils=require("./configUtils");var logger=_rorLoggerFactory.RorLoggerFactory.getLoggerForFile(__filename);function onKibanaConfigParse(e){initLogsAndPrintDeepObject(e);if(!e||_.isEmpty(e)){return e}(0,_unsupportedFeaturesNotifier.verifyNoUnsupportedFeaturesConfigSupplied)(e);try{var r=(0,_kibanaYamlElasticsearchConfigParser.parseElasticsearchConfig)(e.elasticsearch);var a=(0,_kibanaYamlKibanaConfigParser.parseKibanaConfigForPkp)(e);var i=(0,_kibanaYamlKibanaConfigParser.parseKibanaConfigForPep)(e,r.kibanaTechUserEsCredentials);var n=(0,_kibanaYamlRorConfigParser.parseRorConfig)(e);var o=initializeSharedServices(r,a,i,n);(0,_rorStoreInitializer.initializeRorStore)(a,n);initializePkp(a,n,o,r);initializePep(i,o);return updateKibanaConfigDeepObject(e,a,i)}catch(e){logger.error("ROR Cannot initialize Kibana: "+e.message,e);(0,_configUtils.exitInOneSecond)()}}function initLogsAndPrintDeepObject(e){var r;_rorLoggerFactory.RorLoggerFactory.initLogs((0,_kibanaYamlLogLevelParser.parseLogLevel)(e),(r=e.logging)===null||r===void 0?void 0:r.dest);logger.trace("Found configuration object:\n ".concat(JSON.stringify(e,null,2)))}function initializeSharedServices(e,r,a,i){var n=new _cookieManager.CookieManager(i.cookieConfig);var o=new _esSSLConnectionProvider.EsSSLConnectionProvider(e.sslConfig);var t=new _esHostBalancer.EsHostBalancer(e.elasticsearchHosts,a.networkParameters,e.kibanaTechUserEsCredentials,o);var s=new _esClient.EsClient(e.kibanaTechUserEsCredentials,t,o);var c=_sessionManagerFactory.SessionManagerFactory.build(s,i.sessionManagerConfig,i.sessionConfig);var g=new _rorRequestAppender.RorRequestAppender(c,n);return{cookieManager:n,esSSLConnectionProvider:o,esHostBalancer:t,esClient:s,sessionManager:c,rorRequestAppender:g}}function initializePkp(e,r,a,i){var n={pkpHostAndPort:e.pkpHostAndPort,kibanaUrl:e.kibanaUrl,kibanaIndex:e.kibanaIndex,kibanaTemplateIndex:r.kibanaTemplateIndex,kibanaTemplateIndexSurplusRemovalEnabled:r.kibanaTemplateIndexSurplusRemovalEnabled,kibanaBasePath:e.kibanaBasePath,pkpKibanaToken:r.pkpKibanaToken,auth:r.authConfig,sessionConfig:r.sessionConfig,kibanaSSLConfig:e.kibanaSslConfig,customUXCodeInjection:r.customUXCodeInjection,customLogoutLink:r.customLogoutLink,customLoginLink:r.customLoginLink,proxyAuth:r.proxyAuthConfig,jwtQueryParam:r.jwtQueryParam,whitelistedPaths:r.whitelistedPaths,requestHeadersWhitelist:i.requestHeadersWhitelist,loginPageCustomizations:r.loginPageCustomizations,cookieConfig:r.cookieConfig,clearSessionOnEvents:r.clearSessionOnEvents};new _preKibanaProxy.PreKibanaProxy(a.sessionManager,a.cookieManager,a.rorRequestAppender,a.esClient,n)}function initializePep(e,r){var a={port:e.pepPort,networkParameters:e.networkParameters,kibanaIndex:e.kibanaIndex,reportingIndex:e.reportingIndex,kibanaTechUserEsCredentials:e.kibanaTechUserEsCredentials};new _preElasticsearchProxy.PreElasticsearchProxy(r.sessionManager,r.rorRequestAppender,r.esHostBalancer,r.esSSLConnectionProvider,a)}function updateKibanaConfigDeepObject(e,r,a){_.update(e,'server.ssl.enabled',function(e){logger.debug("Overriding 'server.ssl.enabled' from ".concat(e," to false"));return false});_.update(e,'server.port',function(e){logger.debug("Overriding 'server.port' from ".concat(e," to ").concat(r.newKibanaPort));return r.newKibanaPort});_.update(e,'server.host',function(e){logger.debug("Overriding 'server.host' from ".concat(e," to 127.0.0.1"));return"127.0.0.1"});_.update(e,'elasticsearch.hosts',function(e){logger.debug("Overriding 'elasticsearch.hosts' from ".concat(e," to [").concat(a.pepUrl,"]"));return[a.pepUrl]});_.update(e,'elasticsearch.requestHeadersWhitelist',function(e){var r=(e||["authorization"]).concat(["cookie"]);logger.debug("Overriding 'elasticsearch.requestHeadersWhitelist' from ".concat(JSON.stringify(e)," to ").concat(JSON.stringify(r)));return r});return e}